# Suggestions — Post Refactor Phase 2

**Date:** 2026-02-22  
**Context:** State Machine + Codex + Admin Dashboard refactor complete. Pages need wiring to new engine.

---

## S-01: Wire `CharacterSelectPage` to Redux State Machine

**Priority:** HIGH  
**Files:** `src/web/lite-game/pages/phases/character-select/CharacterSelectPage.tsx`

**Current behavior:**  
- Inserts into 3 Supabase tables immediately on character creation.
- Saves `player.id` to `localStorage`.
- Navigates directly to `/lite-game/level/1`.

**Suggested behavior:**  
1. On submit, dispatch `selectVessel({ vesselId: selectedClass, light: startingLight, dark: startingDark })`.
2. This transitions phase to `STAGING` — let the router / phase guard handle navigation.
3. **Defer** Supabase writes. Store the Supabase player ID in Redux state (add `playerId: string | null` to `GameState`) or in a separate persistence slice. Write to Supabase only at run boundaries.
4. Remove `localStorage.setItem('lite_game_player_id', ...)`.

**Reference:** `Door.tsx` for the dispatch-first pattern.

---

## S-02: Fix `LevelPage` Dispatch Calls

**Priority:** CRITICAL (runtime bugs)  
**Files:** `src/web/lite-game/pages/phases/level/LevelPage.tsx`

**Bugs:**
1. Dispatches `{ type: 'gameEngine/addLight' }` and `{ type: 'gameEngine/addDark' }` — these actions **do not exist** in `gameSlice.ts`. They silently no-op.
2. Dispatches `syncProgress` with only `{ currentLight, currentDark }` — missing required `currentLevel` field. Sets `currentLevel` to `undefined`.

**Fix:**
```tsx
// Replace addLight/addDark with:
dispatch(playCard({ lightDelta: drawnCard.light_reward, darkDelta: drawnCard.dark_reward }));

// Replace syncProgress with:
dispatch(syncProgress({
  currentLight: progress.current_light,
  currentDark: progress.current_dark,
  currentLevel: progress.current_level,
}));
```

Also remove `localStorage.getItem('lite_game_player_id')` — read player context from Redux.

---

## S-03: Wire `DoorChoicePage` to `attemptDoor`

**Priority:** HIGH  
**Files:** `src/web/lite-game/pages/phases/door-choice/DoorChoicePage.tsx`

**Current behavior:**  
- Imports `setLevel` (legacy setter) and dispatches it.
- Writes events, progress, and completion to Supabase per door choice.

**Suggested behavior:**  
1. Replace `setLevel` import with `attemptDoor`.
2. On door click: `dispatch(attemptDoor({ doorType, cost }))`.
3. Use a `useEffect` watching `phase` to navigate:
   - `STAGING` → `/lite-game/level/${currentLevel}`
   - `DUDAEL_DROP` → penalty page or game-over flow
4. Remove all per-action Supabase writes. Batch event data in a local array and persist at run end.

**Reference:** `Door.tsx` already implements this pattern correctly. Consider consolidating `DoorChoicePage` to use `Door.tsx` internally.

---

## S-04: Wire `GameOverPage` to Redux State

**Priority:** MEDIUM  
**Files:** `src/web/lite-game/pages/phases/game-over/GameOverPage.tsx`

**Current behavior:**  
- Reads `playerId` from localStorage.
- Fetches final stats from Supabase (PLAYER_PROGRESS + PLAYERS).

**Suggested behavior:**  
1. Read stats from `useAppSelector(state => state.gameEngine)` — `currentLight`, `currentDark`, `currentLevel`, `vessel`.
2. On mount (or via a `useEffect`), batch-write final stats to Supabase if not already persisted.
3. Remove `localStorage.getItem` and `localStorage.removeItem`.
4. `resetGame()` dispatch is correct — keep it.

---

## S-05: Migrate `useGameState` to Typed Hooks

**Priority:** LOW  
**Files:** `src/web/lite-game/hooks/useGameState.ts`

**Current:**
```ts
import { useSelector, useDispatch } from 'react-redux';
```

**Suggested:**
```ts
import { useAppSelector, useAppDispatch } from '@/app/hooks';
```

This aligns with the project convention and provides proper `RootState`/`AppDispatch` typing without manual annotations.

---

## S-06: Sync Vessel Definitions

**Priority:** MEDIUM  
**Files:** `src/web/lite-game/types/characters.ts`, `src/web/game-lore/pages/codex/LorePage/index.tsx`

`characters.ts` defines 3 vessels (Seraph, Shadow, Exile). `LorePage` renders 5 (adds The Penitent, The Rebel).

**Options:**
1. **Expand `characters.ts`** — add Penitent and Rebel as selectable vessels with appropriate starting bonuses. Update `CharacterOption['class']` union type.
2. **Keep 3 playable, 5 in lore** — mark Penitent and Rebel as `unlockable: true` in a separate lore-only data structure. Either way, share one canonical vessel list.

**Recommendation:** Option 2 for now — create a `VESSEL_LORE` constant in `src/web/game-lore/` that extends `CHARACTERS` with the 2 additional lore-only vessels.

---

## S-07: Add Phase-Based Route Guards

**Priority:** MEDIUM  
**Files:** `src/app/router/lite-game/phase.tsx`

Currently nothing prevents a user from navigating directly to `/lite-game/game-over` without going through the game flow. Add a wrapper component or loader that checks `state.gameEngine.phase` and redirects if the phase doesn't match the route.

```tsx
// Example: PhaseGuard component
function PhaseGuard({ required, children }: { required: GamePhase; children: React.ReactNode }) {
  const phase = useAppSelector(s => s.gameEngine.phase);
  if (phase !== required) return <Navigate to="/lite-game" replace />;
  return <>{children}</>;
}
```

---

## S-08: Fix Route / Link Mismatch

**Priority:** LOW  
**Files:** `src/web/lite-game/pages/HomePage/index.tsx`, `src/app/router/lite-game/phase.tsx`

`HomePage` links to `/lite-game/title-start` but the router maps `/lite-game` to `LiteGameHome`. Either:
1. Add a `/lite-game/title-start` route that renders the same component, or
2. Update the `HomePage` link to `/lite-game`.

---

## S-09: Add `playerId` to Redux `GameState`

**Priority:** HIGH  
**Files:** `src/app/store/gameSlice.ts`

To fully eliminate `localStorage` for player identity, add `playerId: string | null` to `GameState`. Set it during `selectVessel` (or a new `createPlayer` action). All pages can then read it from Redux instead of `localStorage`.

```ts
export interface GameState {
  // ... existing fields
  playerId: string | null;
}

// In selectVessel or a new action:
state.playerId = action.payload.playerId;
```

---

## S-10: Clean Up Stale Comments and Files

**Priority:** LOW  

1. `codex.tsx` line 1: `"Inside src/app/router/lite-game.tsx"` → should say `codex.tsx`.
2. `BrandSpecimen.tsx` appears to be the old `BrandDashboardPage.tsx` renamed — verify if it's still needed alongside the new `BrandOpsDashboard.tsx`.
3. `queryClient;` bare expressions in `CharacterSelectPage` and `LevelPage` — replace with `void queryClient;` or `_queryClient` parameter name to satisfy lint.

---

## S-11: Replace `any` Types in `lite-game.ts`

**Priority:** LOW  
**Files:** `src/web/lite-game/types/lite-game.ts`

`Skill.effect_data` and `GameEvent.event_data` use `Record<string, any>`. Define specific interfaces:

```ts
interface SkillEffect {
  type: 'buff' | 'debuff' | 'transform';
  magnitude: number;
  duration?: number;
}

interface GameEventData {
  card_id?: string;
  door_type?: 'light' | 'dark' | 'secret';
  light_spent?: number;
  dark_spent?: number;
  [key: string]: unknown; // fallback
}
```
